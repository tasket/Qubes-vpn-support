#!/bin/sh

########################################################################
##
##  proxy-firewall-restrict
##  Configure Qubes firewall for use with a tunnel such as OpenVPN.
##
##  Note: For customization, add rules to a filename in firewall.d
##  other than '90_tunnel-restrict'.


groupadd -rf qvpn && sync

# Set firewall restriction policy

# Stop all leaks between downstream (vif+) and upstream (Internet eth0):
nft chain ip qubes forward '{ policy drop; }'
nft insert rule ip qubes custom-forward oifgroup 1 drop
nft insert rule ip qubes custom-forward iifgroup 1 drop

nft chain ip6 qubes forward '{ policy drop; }'
nft insert rule ip6 qubes custom-forward oifgroup 1 drop
nft insert rule ip6 qubes custom-forward iifgroup 1 drop

# Accept forward traffic between dowstream (vif+, group 2) and VPN interface (group 9)
nft insert rule ip qubes custom-forward iifgroup 2 oifgroup 9 accept
nft insert rule ip qubes custom-forward iifgroup 9 oifgroup 2 accept
nft insert rule ip6 qubes custom-forward iifgroup 2 oifgroup 9 accept
nft insert rule ip6 qubes custom-forward iifgroup 9 oifgroup 2 accept

# Block INPUT from tunnel(s):
nft chain ip qubes input '{ policy drop; }'
nft chain ip6 qubes input '{ policy drop; }'

# Create output chain since it's not created by Qubes by default
nft add chain ip qubes output '{ type filter hook output priority 0; policy accept; }'
nft add chain ip6 qubes output '{ type filter hook output priority 0; policy accept; }'

# Disable icmp packets
if [ -e /var/run/qubes-service/vpn-handler-no-icmp ]; then
  nft insert rule ip qubes custom-input meta l4proto icmp drop
  nft insert rule ip6 qubes custom-input meta l4proto icmp drop

  nft insert rule ip qubes output oifgroup 1 meta l4proto icmp drop
  nft insert rule ip6 qubes output oifgroup 1 meta l4proto icmp drop
else
  nft insert rule ip qubes output meta l4proto icmp skgid qvpn accept
  nft insert rule ip6 qubes output meta l4proto icmp skgid qvpn accept
fi

###-------------------------------------------------------------------###
# This section executed only if vpn-handler-egress service _not_ enabled:
if [ -e /var/run/qubes-service/vpn-handler-egress ]; then
    exit 0
fi

# Extra restriction prevents accidental communications from within VPN VM to net;
# The gid-owner rule requires net programs be run with group ID 'qvpn'
# to allow outbound traffic.
nft chain ip qubes output '{ policy drop; }'
nft insert rule ip qubes output oif "lo" accept
nft insert rule ip qubes output oifgroup 1 skgid qvpn accept

nft chain ip6 qubes output '{ policy drop; }'
nft insert rule ip6 qubes output oif "lo" accept
nft insert rule ip6 qubes output oifgroup 1 skgid qvpn accept
