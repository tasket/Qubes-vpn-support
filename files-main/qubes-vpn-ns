#!/bin/bash

###########################################################################
##  qubes-vpn-ns
##
## Handles DHCP-source DNS addresses & link notification for Qubes VPN VMs.
## To use, set as 'up' and 'down' script with parameter in your VPN config.
##
## Use 'vpn_dns' environment var as override/alternative.
## In openvpn config, format is: setenv vpn_dns 'X.X.X.X  Y.Y.Y.Y [...]'
##
## Christopher Laprise, 2018-2020  -  https://github.com/tasket

set -e
export PATH="$PATH:/usr/sbin:/sbin:/bin"
nspath=/var/run/qubes/qubes-vpn-ns
rm -f $nspath
hostname=$(hostname)

do_notify() {
    if [ ! -e /etc/fedora-release-NONE ]; then
        echo \'"sleep 2; notify-send \"$hostname: $1\"" --icon=$2\' | xargs su - user -c &
    fi
}


case "$1" in
up|test-up)
    rm -f $nspath
    if [[ -z "$vpn_dns" ]] ; then
        # Parses DHCP option variables to set DNS address translation:
        for optionname in ${!foreign_option_*} ; do
            option="${!optionname}"
            unset fops; fops=($option)
            if [ ${fops[1]} == "DNS" ] ; then vpn_dns="${fops[2]} $vpn_dns" ; fi
        done
    fi

;;&
up)
    # Flush redirects to Qubes OS virtual DNS servers
    # from qubes connected to this qube
    nft flush chain ip qubes dnat-dns
    # ip6 qubes dnat-dns chain is missing upstream so fix it here for now
    nft add chain ip6 qubes dnat-dns '{ type nat hook prerouting priority dstnat; policy accept; }'
    nft flush chain ip6 qubes dnat-dns
    if [[ -n "$vpn_dns" ]] ; then
        # Set DNS address translation in firewall:
        echo "$vpn_dns " >$nspath
        echo "Using DNS servers $vpn_dns"
        . /var/run/qubes/qubes-ns
        
        vpn_dns_ip4=()
        vpn_dns_ip6=()
        for DNS in $vpn_dns; do
            if [[ $DNS =~ .*\..* ]] ; then
                vpn_dns_ip4+=($DNS)
            elif [[ $DNS =~ .*:.* ]] ; then
                vpn_dns_ip6+=($DNS)
            fi
        done

        qubes_dns_ip4=()
        qubes_dns_ip6=()
        for NS in $NS1 $NS2; do
            if [[ $NS =~ .*\..* ]] ; then
                qubes_dns_ip4+=($NS)
            elif [[ $NS =~ .*:.* ]] ; then
                qubes_dns_ip6+=($NS)
            fi
        done

        if [[ ${#vpn_dns_ip4[@]} != 0 ]] && [[ ${#qubes_dns_ip4[@]} != 0 ]]; then
            for i in $(seq 0 $((${#qubes_dns_ip4[@]} - 1))); do
                if [[ $i < ${#vpn_dns_ip4[@]} ]] ; then
                    nft add rule ip qubes dnat-dns iifgroup 2 ip daddr ${qubes_dns_ip4[$i]} tcp dport 53 dnat to ${vpn_dns_ip4[$i]}
                    nft add rule ip qubes dnat-dns iifgroup 2 ip daddr ${qubes_dns_ip4[$i]} udp dport 53 dnat to ${vpn_dns_ip4[$i]}
                else
                    nft add rule ip qubes dnat-dns iifgroup 2 ip daddr ${qubes_dns_ip4[$i]} tcp dport 53 dnat to ${vpn_dns_ip4[0]}
                    nft add rule ip qubes dnat-dns iifgroup 2 ip daddr ${qubes_dns_ip4[$i]} udp dport 53 dnat to ${vpn_dns_ip4[0]}
                fi
            done
        fi
        
        if [[ ${#vpn_dns_ip6[@]} != 0 ]] && [[ ${#qubes_dns_ip6[@]} != 0 ]]; then
            for i in $(seq 0 $((${#qubes_dns_ip6[@]} - 1))); do
                if [[ $i < ${#vpn_dns_ip6[@]} ]] ; then
                    nft add rule ip6 qubes dnat-dns iifgroup 2 ip6 daddr ${qubes_dns_ip6[$i]} tcp dport 53 dnat to ${qubes_dns_ip6[$i]}
                    nft add rule ip6 qubes dnat-dns iifgroup 2 ip6 daddr ${qubes_dns_ip6[$i]} udp dport 53 dnat to ${qubes_dns_ip6[$i]}
                else
                    nft add rule ip6 qubes dnat-dns iifgroup 2 ip6 daddr ${qubes_dns_ip6[$i]} tcp dport 53 dnat to ${qubes_dns_ip6[0]}
                    nft add rule ip6 qubes dnat-dns iifgroup 2 ip6 daddr ${qubes_dns_ip6[$i]} udp dport 53 dnat to ${qubes_dns_ip6[0]}
                fi
            done
        fi
        do_notify "LINK IS UP." "network-idle"
    else
        do_notify "LINK UP, NO DNS!" "dialog-error"
    fi

;;
test-up)

##  Use test-up parameter to test your basic VPN link before enabling firewall script.
##  Do NOT use beyond testing period.
    if [[ -z "$vpn_dns" ]]; then echo "NO DNS ADDRESS FOUND."; exit 0; fi
    [ -e /etc/resolv.vpnbak ] || cp -a /etc/resolv.conf /etc/resolv.vpnbak
    rm /etc/resolv.conf
    for DNS in $vpn_dns; do
        echo "nameserver $DNS" >>/etc/resolv.conf
    done
    /usr/lib/qubes/qubes-setup-dnat-to-ns
    do_notify "TEST LINK IS UP." "network-idle"

;;
down)
    nft flush chain ip qubes dnat-dns
    nft flush chain ip6 qubes dnat-dns
    do_notify "LINK IS DOWN !" "dialog-error"

;;
esac
